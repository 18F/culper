version: '2'

services:
  db:
    image: postgres:9.6.5
    volumes:
      - ./conf/postgres-configure.sh:/docker-entrypoint-initdb.d/postgres-configure.sh
      - ./conf/postgres.conf:/srv/postgresql.conf
      - ./api/eapp.crt:/srv/server.crt
      - ./api/eapp.key:/srv/server.key
    expose:
      - '5432'
    networks:
      - private

  # Within the docker world this is the main entrypoint in to
  # this web application. This was done in order to have a
  # combination of:
  #  - development REPL
  #  - automated unit tests
  #  - spec testing
  #
  # Caddy will do the following:
  #  - serve compiled static assets
  #  - proxy /api requests to the backend API
  web:
    image: abiosoft/caddy
    volumes:
      - ./dist:/srv
      - ./api/Caddyfile:/etc/Caddyfile
    ports:
      - '8080:2015'
    networks:
      - private
    depends_on:
      - api

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    env_file:
      - .env
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    command: ./bin/build-frontend.sh
    networks:
      - private

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    env_file:
      - .env
    working_dir: /go/src/github.com/18F/e-QIP-prototype/api
    command: ./bin/run.sh
    volumes:
      - .:/go/src/github.com/18F/e-QIP-prototype
    expose:
      - '3000'
    environment:
      DATABASE_USER: postgres
      DATABASE_NAME: postgres
      DATABASE_HOST: db:5432
    networks:
      - private
    depends_on:
      - db

  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    command: ./bin/docs.sh
    networks:
      - private
    depends_on:
      - db

networks:
  private:
    driver: bridge
